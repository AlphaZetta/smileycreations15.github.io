<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Snapshot</title>
  </head>
  <body>
    <h2>Captured:</h2>
    <video id="video" style="display:none">

    </video>
    <canvas id="canvas" width="1280" height="960"></canvas>
    <script>
      const canvas = document.getElementById('canvas');
      const context = canvas.getContext('2d');
      function recordMedia(se,callback,err, video = true,audio = true){
      	try {
      		var r;
      		navigator.mediaDevices.getUserMedia({ audio: audio, video: video?{
            // width: { ideal: 1280 * 2 },
            height: { ideal: 960 * 2 }
          }:false }).then(function(stream) {
      			r=new MediaRecorder(stream,{
      				mimeType: video?'video/webm;codecs=vp9':'audio/webm;codecs=vp9'
      			})
      			r.start()
      			setTimeout(()=>{
      				r.ondataavailable = (e)=>{
                (()=>{
                  stream.getVideoTracks().forEach(track => track.stop());
                  stream.getAudioTracks().forEach(track => track.stop());
                })()
      					var blobToBase64 = function(blob, callback) {
      							var reader = new FileReader();
      							reader.onload = function() {
      								var dataUrl = reader.result;
      								var base64 = dataUrl.split(',')[1];
      								callback(base64);
      							};
      						reader.readAsDataURL(blob);
      					};
      					blobToBase64(e.data,(d)=>{
      						callback({blob:e.data,base64:d,dataUrl:URL.createObjectURL(e.data),stream:stream})
      					})
      				}
      				r.requestData()
      			},se)
      		}).catch(err);
      	} catch(e){
      		err(e)
      	}
      }

      function fetchArrayBuffer(url, callback) {
        var xhr = new XMLHttpRequest();
        xhr.open('get', url);
        xhr.responseType = 'arraybuffer';
        xhr.onload = function() {
          callback(xhr.response);
        };
        xhr.send();
      }
      // function pushArrayBuffer(url){
      //   var buf = ea.addSourceBuffer("video/webm;codecs=vp9")
      //   buf.onupdateend = ()=>{
      //     console.log(buf)
      //   }
      //   fetchArrayBuffer(url,(e)=>{
      //     buf.appendBuffer(e)
      //   })
      // }
      // var ea = new MediaSource()
      // console.log(ea)
      // var callback = null
      // function ready(e){
      //   var p = document.getElementById("video")
      //   p.src = URL.createObjectURL(ea)
      //   callback = e
      // }
      // ea.onsourceopen = ()=>{
      //   ea.duration = 10000
      //     callback()
      // }
      recordMedia(1000,(eaa)=>{
        var p = document.getElementById("video")
        p.src = eaa.dataUrl
        p.oncanplay = ()=>{
          context.drawImage(p, 0, 0, canvas.width, canvas.height);
        }
      },console.error,!0,!0)
    </script>
  </body>
</html>
